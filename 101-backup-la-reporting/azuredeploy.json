{
    "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion":"1.0.0.0",
    "parameters":{
      "workspaceLocation": {
         "type": "string",
         "metadata": {
           "description": "Specify the workspace region"
         }
       },
      
       "workspaceName":{
          "type":"string",
          "metadata":{
             "description":"Specify the workspace name"
          }
       },
       "_artifactsLocation":{
          "type":"string",
          "defaultValue":"https://raw.githubusercontent.com/adityabalaji-msft/azure-quickstart-templates/adbalaji-working-branch-001/101-backup-oms-monitoring",
          "metadata":{
             "description":"The base URI where artifacts required by this template are located"
          }
       },
       "_artifactsLocationSasToken":{
          "type":"securestring",
          "defaultValue":"",
          "metadata":{
             "description":"The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated"
          }
       }
    },
    "variables":{
       "nestedTemplates":{
          "backup_jobs_non_log":"[concat(parameters('_artifactsLocation'), '/nestedtemplates/backup_jobs_non_log.json', parameters('_artifactsLocationSasToken'))]",
          "backup_jobs_log":"[concat(parameters('_artifactsLocation'), '/nestedtemplates/backup_jobs_log.json', parameters('_artifactsLocationSasToken'))]",
          "restore_jobs":"[concat(parameters('_artifactsLocation'), '/nestedtemplates/restore_jobs.json', parameters('_artifactsLocationSasToken'))]",
          "azure_alerts":"[concat(parameters('_artifactsLocation'), '/nestedtemplates/azure_alerts.json', parameters('_artifactsLocationSasToken'))]",
          "on_prem_alerts":"[concat(parameters('_artifactsLocation'), '/nestedtemplates/on_prem_alerts.json', parameters('_artifactsLocationSasToken'))]",
          "backup_items":"[concat(parameters('_artifactsLocation'), '/nestedtemplates/backup_items.json', parameters('_artifactsLocationSasToken'))]",
          "cloud_storage":"[concat(parameters('_artifactsLocation'), '/nestedtemplates/cloud_storage.json', parameters('_artifactsLocationSasToken'))]"
       },
       "omsSolutions":{
          "customSolution":{
             "name":"Azure Backup Monitoring Solution",
             "view1":"Backup+Jobs+%28Non+Log%29",
             "view2":"Backup+Jobs+%28Log%29",
             "view3":"Restore+Jobs",
             "view4":"Alerts+from+Azure+Resources+Backup",
             "view5":"Alerts+from+On-Premises+Resources+Backup",
             "view6":"Backup+Items",
             "view7":"Cloud+Storage",
             "solutionName":"[concat('AzureBackup', '[', parameters('workspaceName'), ']')]",
             "publisher":"Microsoft",
             "displayName":"Azure Backup Monitoring and Reporting Solution",
             "description":"Analyze your Backup Vaults",
             "author":"Microsoft"
          }
       }
    },

          "resources":[
             {
                "apiVersion":"2015-11-01",
                "name": "Backup+Jobs+%28Non+Log%29",
                "type":"Microsoft.Resources/deployments",
                "properties":{
                   "mode":"Incremental",
                   "templateLink":{
                      "uri":"[variables('nestedTemplates').backup_jobs_non_log]",
                      "contentVersion":"1.0.0.0"
                   },
                   "parameters":{
                     "workspaceLocation":{"value": "[parameters('workspaceLocation')]"} ,
                     "workspaceName":{"value": "[parameters('workspaceName')]"} 
                  
                  }
                   
                  
                }
             },
             {
                "apiVersion":"2015-11-01",
                "name":"Backup+Jobs+%28Log%29",
                "type":"Microsoft.Resources/deployments",
                "properties":{
                   "mode":"Incremental",
                   "templateLink":{
                      "uri":"[variables('nestedTemplates').backup_jobs_log]",
                      "contentVersion":"1.0.0.0"
                   },
                   "parameters":{
                     "workspaceLocation":{"value": "[parameters('workspaceLocation')]"} ,
                     "workspaceName":{"value": "[parameters('workspaceName')]"} 
                  
                  }
                  
                }
               },
             {
                "apiVersion":"2015-11-01",
                "name":"Restore+Jobs",
                "type":"Microsoft.Resources/deployments",
                "properties":{
                   "mode":"Incremental",
                   "templateLink":{
                      "uri":"[variables('nestedTemplates').restore_jobs]",
                      "contentVersion":"1.0.0.0"
                   },
                   "parameters":{
                     "workspaceLocation":{"value": "[parameters('workspaceLocation')]"} ,
                     "workspaceName":{"value": "[parameters('workspaceName')]"} 
                  
                  }
                   
                }
             },
             {
                "apiVersion":"2015-11-01",
                "name":"Alerts+from+Azure+Resources+Backup",
                "type":"Microsoft.Resources/deployments",
                "properties":{
                   "mode":"Incremental",
                   "templateLink":{
                      "uri":"[variables('nestedTemplates').azure_alerts]",
                      "contentVersion":"1.0.0.0"
                   },
                   "parameters":{
                     "workspaceLocation":{"value": "[parameters('workspaceLocation')]"} ,
                     "workspaceName":{"value": "[parameters('workspaceName')]"} 
                  
                  }
                   
                }
             },
             {
                "apiVersion":"2015-11-01",
                "name":"Alerts+from+On-Premises+Resources+Backup",
                "type":"Microsoft.Resources/deployments",
               
                "properties":{
                   "mode":"Incremental",
                   "templateLink":{
                      "uri":"[variables('nestedTemplates').on_prem_alerts]",
                      "contentVersion":"1.0.0.0"
                   },
                   "parameters":{
                     "workspaceLocation":{"value": "[parameters('workspaceLocation')]"} ,
                     "workspaceName":{"value": "[parameters('workspaceName')]"} 
                  
                  }
                }
             },
             {
                "apiVersion":"2015-11-01",
                "name":"Backup+Items",
                "type":"Microsoft.Resources/deployments",
                "properties":{
                   "mode":"Incremental",
                   "templateLink":{
                      "uri":"[variables('nestedTemplates').backup_items]",
                      "contentVersion":"1.0.0.0"
                   },
                   "parameters":{
                     "workspaceLocation":{"value": "[parameters('workspaceLocation')]"} ,
                     "workspaceName":{"value": "[parameters('workspaceName')]"} 
                  
                  }
                }
             },
             {
                "apiVersion":"2015-11-01",
                "name":"Cloud+Storage",
                "type":"Microsoft.Resources/deployments",
                
                "properties":{
                   "mode":"Incremental",
                   "templateLink":{
                      "uri":"[variables('nestedTemplates').Cloud+Storage]",
                      "contentVersion":"1.0.0.0"
                   },
                   "parameters":{
                     "workspaceLocation":{"value": "[parameters('workspaceLocation')]"} ,
                     "workspaceName":{"value": "[parameters('workspaceName')]"} 
                  
                  }
                }
             },
             {
                "name":"[variables('omsSolutions').customSolution.solutionName]",
                "type":"Microsoft.OperationsManagement/solutions",
                "apiVersion":"2015-11-01-preview",
                "location": "[parameters('workspaceLocation')]",
                "dependsOn":[
                 
                 
                   "[concat('Microsoft.Resources/deployments/', variables('omsSolutions').customSolution.view1)]",
                   "[concat('Microsoft.Resources/deployments/', variables('omsSolutions').customSolution.view2)]",
                   "[concat('Microsoft.Resources/deployments/', variables('omsSolutions').customSolution.view3)]",
                   "[concat('Microsoft.Resources/deployments/', variables('omsSolutions').customSolution.view4)]",
                   "[concat('Microsoft.Resources/deployments/', variables('omsSolutions').customSolution.view5)]",
                   "[concat('Microsoft.Resources/deployments/', variables('omsSolutions').customSolution.view6)]",
                   "[concat('Microsoft.Resources/deployments/', variables('omsSolutions').customSolution.view7)]"
                ],
                "plan":{
                   "name":"[variables('omsSolutions').customSolution.solutionName]",
                   "product":"[variables('omsSolutions').customSolution.name]",
                   "publisher":"[variables('omsSolutions').customSolution.publisher]",
                   "promotionCode":""
                },
                "properties":{
                   "workspaceResourceId":"[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]",
                   "referencedResources":[
 
                   ],
                   "containedResources":[
                     "[resourceId('Microsoft.OperationalInsights/workspaces/views/', parameters('workspaceName'), variables('omsSolutions').customSolution.view1)]",
                     "[resourceId('Microsoft.OperationalInsights/workspaces/views/', parameters('workspaceName'), variables('omsSolutions').customSolution.view2)]",
                     "[resourceId('Microsoft.OperationalInsights/workspaces/views/', parameters('workspaceName'), variables('omsSolutions').customSolution.view3)]",
                     "[resourceId('Microsoft.OperationalInsights/workspaces/views/', parameters('workspaceName'), variables('omsSolutions').customSolution.view4)]",
                     "[resourceId('Microsoft.OperationalInsights/workspaces/views/', parameters('workspaceName'), variables('omsSolutions').customSolution.view5)]",
                     "[resourceId('Microsoft.OperationalInsights/workspaces/views/', parameters('workspaceName'), variables('omsSolutions').customSolution.view6)]",
                     "[resourceId('Microsoft.OperationalInsights/workspaces/views/', parameters('workspaceName'), variables('omsSolutions').customSolution.view7)]"
                   ]
                }
             }
          ]
        
    
 }